<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DashGo POD</title>

<style>
body{
    background:#000;
    color:#00ff00;
    font-family:monospace;
    font-size:12px;
    font-weight:bold;
    margin:0;
    padding:10px;
}
.container{max-width:260px;margin:0 auto;}
.header{text-align:center;}
hr{border:0;border-top:1px dashed #00ff00;margin:10px 0;}
label{display:block;margin-top:8px;}
input,select,button,textarea{
    width:100%;
    background:#000;
    color:#00ff00;
    border:1px solid #00ff00;
    font-family:monospace;
    font-size:12px;
    font-weight:bold;
    padding:4px;
    margin-top:4px;
}
button{margin-top:10px;}
.hidden{display:none;}
.msg{margin-top:8px;font-size:11px;}
canvas{border:1px solid #00ff00;margin-top:4px;}
</style>
</head>

<body>

<div class="container">

<div class="header">DashGo Logon POD</div>
<hr>

<div id="loginBox">
    <label>CID</label>
    <input type="text" id="cid">
    <label>PID</label>
    <input type="text" id="pid">
    <button onclick="logon()">LOGON</button>
    <div id="loginMsg" class="msg"></div>
</div>

<div id="pickupBox" class="hidden">

    <label>Confirm Tracking ID</label>
    <input type="text" id="trk" oninput="checkSignatureField()">

    <label>Date / Time</label>
    <input type="text" id="dt" readonly>

    <label>Location</label>
    <input type="text" id="loc">

    <label>Status</label>
    <select id="status" onchange="checkSignatureField()">
        <option>ITEM DATA RECEIVED</option>
        <option>ITEM HANDED TO COURIER</option>
        <option>ITEM SCANNED AT UNLOAD HUB</option>
        <option>ITEM PROCESSED</option>
        <option>ITEM MOVING THRU NETWORK</option>
        <option>ITEM DEPARTED HUB</option>
        <option>ITEM EN ROUTE</option>
        <option>ITEM DELAYED</option>
        <option>ITEM SCANNED AT LOCAL UNLOAD HUB</option>
        <option>ITEM PROCESSED WITH LOAD HUB</option>
        <option>ITEM OUT FOR DELIVERY</option>
        <option>ITEM DELIVERED</option>
    </select>

    <!-- Signature Field -->
    <div id="sigBox" class="hidden">
        <label>Signature (Required)</label>
        <canvas id="signature" width="240" height="100"></canvas>
        <button onclick="clearSig()">CLEAR SIGNATURE</button>
    </div>

    <button onclick="submitPickup()">CONFIRM PICKUP</button>
    <div id="pickupMsg" class="msg"></div>
</div>

</div>

<script>
var CID="",PID="";
var URL="https://script.google.com/macros/s/AKfycbzgBEwDq1Hwl1weE2YbjHgeHhv3GdELuVkRpGYwwrZ4VQo0V5KQtDLmnFSyIRpr5fwI/exec";

// Date/time
function dt(){
    var d=new Date();
    document.getElementById("dt").value=
    d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+" "+
    d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();
}

// Logon
function logon(){
    CID=document.getElementById("cid").value;
    PID=document.getElementById("pid").value;
    if(CID==""||PID==""){alert("CID / PID REQUIRED");return;}

    var x=new XMLHttpRequest();
    x.open("POST",URL,true);
    x.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
    x.onreadystatechange=function(){
        if(x.readyState==4){
            if(x.responseText=="OK"){
                document.getElementById("loginBox").style.display="none";
                document.getElementById("pickupBox").style.display="block";
                dt();
            }else{
                document.getElementById("loginMsg").innerHTML="INVALID LOGIN";
            }
        }
    };
    x.send("action=login&cid="+encodeURIComponent(CID)+"&pid="+encodeURIComponent(PID));
}

// Signature logic
var canvas=document.getElementById("signature");
var ctx=canvas.getContext("2d");
var drawing=false;
var hasSigned=false;

canvas.addEventListener('mousedown', function(e){
    drawing = true; 
    ctx.moveTo(e.offsetX,e.offsetY);
    hasSigned = true;
});
canvas.addEventListener('mouseup', function(e){drawing=false;});
canvas.addEventListener('mousemove', function(e){
    if(drawing){ctx.lineTo(e.offsetX,e.offsetY); ctx.strokeStyle="#00ff00"; ctx.stroke();}
});

canvas.addEventListener('touchstart', function(e){
    drawing = true; 
    var t=e.touches[0]; 
    ctx.moveTo(t.pageX-canvas.offsetLeft,t.pageY-canvas.offsetTop);
    hasSigned = true;
});
canvas.addEventListener('touchend', function(e){drawing=false;});
canvas.addEventListener('touchmove', function(e){
    e.preventDefault(); 
    if(drawing){
        var t=e.touches[0]; 
        ctx.lineTo(t.pageX-canvas.offsetLeft,t.pageY-canvas.offsetTop); 
        ctx.stroke();
    }
});

function clearSig(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    hasSigned=false;
}

// Show signature field conditionally
function checkSignatureField(){
    var trk=document.getElementById("trk").value;
    var status=document.getElementById("status").value;
    if(status=="ITEM DELIVERED" && /^I.*75$/.test(trk)){
        document.getElementById("sigBox").style.display="block";
    }else{
        document.getElementById("sigBox").style.display="none";
        clearSig();
    }
}

// Submit pickup
function submitPickup(){
    dt();
    var trk=document.getElementById("trk").value;
    var status=document.getElementById("status").value;

    if(trk==""){alert("TRACKING REQUIRED");return;}
    
    // Require signature if conditions met
    if(status=="ITEM DELIVERED" && /^I.*75$/.test(trk)){
        if(!hasSigned){alert("SIGNATURE REQUIRED"); return;}
    }

    var x=new XMLHttpRequest();
    x.open("POST",URL,true);
    x.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
    x.onreadystatechange=function(){
        if(x.readyState==4){
            document.getElementById("pickupMsg").innerHTML=x.responseText;
        }
    };

    x.send(
        "action=pickup"+
        "&cid="+encodeURIComponent(CID)+
        "&pid="+encodeURIComponent(PID)+
        "&trk="+encodeURIComponent(trk)+
        "&dt="+encodeURIComponent(document.getElementById("dt").value)+
        "&loc="+encodeURIComponent(document.getElementById("loc").value)+
        "&status="+encodeURIComponent(status)+
        "&signature="+encodeURIComponent(canvas.toDataURL())
    );
}
</script>

</body>
</html>
