<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DashGo POD</title>

<style>
body{
    background:#000;
    color:#00ff00;
    font-family:monospace;
    font-size:12px;
    font-weight:bold;
    margin:0;
    padding:10px;
}
.container{max-width:260px;margin:0 auto;}
.header{text-align:center;}
hr{border:0;border-top:1px dashed #00ff00;margin:10px 0;}
label{display:block;margin-top:8px;}

.input-wrap{
    display:flex;
    gap:4px;
}

.input-wrap input{
    flex:1;
}

.scan-btn{
    width:36px;
    padding:0;
    font-size:14px;
    cursor:pointer;
}

input,select,button{
    background:#000;
    color:#00ff00;
    border:1px solid #00ff00;
    font-family:monospace;
    font-size:12px;
    font-weight:bold;
    padding:4px;
    margin-top:4px;
}

button{margin-top:10px;}
.hidden{display:none;}
.msg{margin-top:8px;font-size:11px;}
</style>
</head>

<body>

<div class="container">

<div class="header">DashGo Logon POD</div>
<hr>

<div id="loginBox">
    <label>CID</label>
    <input type="text" id="cid">

    <label>PID</label>
    <input type="text" id="pid">

    <button onclick="logon()">LOGON</button>
    <div id="loginMsg" class="msg"></div>
</div>

<div id="pickupBox" class="hidden">

    <label>Confirm Tracking ID</label>
    <div class="input-wrap">
        <input type="text" id="trk" oninput="checkInitialsField()">
        <button class="scan-btn" onclick="scanBarcode()">ðŸ“·</button>
    </div>

    <label>Date / Time</label>
    <input type="text" id="dt" readonly>

    <label>Location</label>
    <input type="text" id="loc">

    <label>Status</label>
    <select id="status" onchange="checkInitialsField()">
        <option>ITEM DATA RECEIVED</option>
        <option>ITEM HANDED TO COURIER</option>
        <option>ITEM SCANNED AT UNLOAD HUB</option>
        <option>ITEM PROCESSED</option>
        <option>ITEM MOVING THRU NETWORK</option>
        <option>ITEM DEPARTED HUB</option>
        <option>ITEM EN ROUTE</option>
        <option>ITEM DELAYED</option>
        <option>ITEM SCANNED AT LOCAL UNLOAD HUB</option>
        <option>ITEM PROCESSED WITH LOAD HUB</option>
        <option>ITEM OUT FOR DELIVERY</option>
        <option>ITEM DELIVERED</option>
    </select>

    <div id="initBox" class="hidden">
        <label>Recipient Initials (Required)</label>
        <input type="text" id="initials" maxlength="4" placeholder="e.g. JS">
    </div>

    <button onclick="submitPickup()">CONFIRM PICKUP</button>
    <div id="pickupMsg" class="msg"></div>
</div>

</div>

<script>
var CID="",PID="";
var URL="https://script.google.com/macros/s/AKfycbzgBEwDq1Hwl1weE2YbjHgeHhv3GdELuVkRpGYwwrZ4VQo0V5KQtDLmnFSyIRpr5fwI/exec";

// ZXing Scan
function scanBarcode(){
    window.location.href =
        "zxing://scan?ret=" +
        encodeURIComponent(window.location.href + "?SCAN_RESULT={CODE}");
}

// Capture ZXing result
(function(){
    var params = window.location.search;
    if(params.indexOf("SCAN_RESULT=") !== -1){
        var code = params.split("SCAN_RESULT=")[1];
        code = decodeURIComponent(code.replace(/\+/g," "));
        document.getElementById("trk").value = code;
        checkInitialsField();
        history.replaceState(null,null,window.location.pathname);
    }
})();

// Date / Time
function dt(){
    var d=new Date();
    document.getElementById("dt").value =
        d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+" "+
        d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();
}

// Logon
function logon(){
    CID=document.getElementById("cid").value.trim();
    PID=document.getElementById("pid").value.trim();

    if(CID==""||PID==""){alert("CID / PID REQUIRED");return;}

    var x=new XMLHttpRequest();
    x.open("POST",URL,true);
    x.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
    x.onreadystatechange=function(){
        if(x.readyState==4){
            if(x.responseText=="OK"){
                document.getElementById("loginBox").style.display="none";
                document.getElementById("pickupBox").style.display="block";
                dt();
            }else{
                document.getElementById("loginMsg").innerHTML="INVALID LOGIN";
            }
        }
    };
    x.send("action=login&cid="+encodeURIComponent(CID)+"&pid="+encodeURIComponent(PID));
}

// Initials logic
function checkInitialsField(){
    var trk=document.getElementById("trk").value;
    var status=document.getElementById("status").value;

    if(status==="ITEM DELIVERED" && /^I.*75$/.test(trk)){
        document.getElementById("initBox").style.display="block";
    }else{
        document.getElementById("initBox").style.display="none";
        document.getElementById("initials").value="";
    }
}

// Submit
function submitPickup(){
    dt();

    var trk=document.getElementById("trk").value.trim();
    var status=document.getElementById("status").value;
    var initials=document.getElementById("initials").value.trim().toUpperCase();

    if(trk==""){alert("TRACKING REQUIRED");return;}

    if(status==="ITEM DELIVERED" && /^I.*75$/.test(trk)){
        if(!/^[A-Z]{1,4}$/.test(initials)){
            alert("VALID INITIALS REQUIRED");
            return;
        }
    }

    var x=new XMLHttpRequest();
    x.open("POST",URL,true);
    x.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
    x.onreadystatechange=function(){
        if(x.readyState==4){
            document.getElementById("pickupMsg").innerHTML=x.responseText;
        }
    };

    x.send(
        "action=pickup"+
        "&cid="+encodeURIComponent(CID)+
        "&pid="+encodeURIComponent(PID)+
        "&trk="+encodeURIComponent(trk)+
        "&dt="+encodeURIComponent(dt.value)+
        "&loc="+encodeURIComponent(loc.value)+
        "&status="+encodeURIComponent(status)+
        "&initials="+encodeURIComponent(initials)
    );
}
</script>

</body>
</html>
